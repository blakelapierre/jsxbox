<html>
  <head>
    <title>mathbox/jsx</title>
  </head>
  <body>
    <script src="handler.js"></script>
    <script src="mathbox-bundle.js"></script>

    <script type="mathbox/jsx">
      const fftSize = 256,
            pointSize = 4;

      <root focus={3}>
        <camera proxy={true} position={[0, 0, 4]} />

        <polar
          position={[0, 1, 0]}
          range={[[-fftSize / 2, fftSize / 2], [0, 255]]}
          scale={[2 * 16 / 9, 1]}>

          <array id="intTime" data={[]} length={fftSize} channels={1} />
          <swizzle order="yx" />
          <spread width={[fftSize, 0, 0, 0]} />
          <point size={pointSize} color="#FF0000" />

          <array id="intFreq" data={[]} length={fftSize / 2} channels={1} />
          <swizzle order={"yx"} />
          <spread width={[fftSize, 0, 0, 0]} />
          <point size={pointSize} color="#0000FF" blending={'add'} opacity={0.9} />
        </polar>

        <cartesian
          position={[0, 0, 0]}
          range={[[-fftSize / 2, fftSize / 2], [-1, 1]]}
          scale={[2 * 16 / 9, 1]}
        >
          <array id="audioTime" data={[]} length={fftSize} channels={1} />
          <swizzle order="yx" />
          <spread width={[fftSize, 0, 0, 0]} />
          <point
            size={pointSize}
            color="#FF0000"
            blending={'add'}
            opacity={0.5}
          />
        </cartesian>

        <cartesian
          position={[0, -1, 0]}
          range={[[-fftSize / 2, fftSize / 2], [-196, 0]]}
          scale={[2 * 16 / 9, 1]}
        >
          <array id="audioFreq" data={[]} length={fftSize / 2} channels={1} />
          <swizzle order={"yx"} />
          <spread width={[fftSize, 0, 0, 0]} />
          <point size={pointSize} color="#0000FF" blending={'add'} opacity={0.8} />
        </cartesian>
      </root>

      const context = new (window.AudioContext || window.webkitAudioContext)();

      navigator.getUserMedia = navigator.getUserMedia
                            || navigator.webkitGetUserMedia
                            || navigator.mozGetUserMedia
                            || navigator.msGetUserMedia;

      navigator.getUserMedia({audio: true}, stream, error);

      function stream(stream) {
        const input = context.createMediaStreamSource(stream),
              analyser = context.createAnalyser();

        input.connect(analyser);

        setAnalyser(analyser);
      }

      function error(error) {
        console.log(error);
      }

      function setAnalyser(analyser) {
        analyser.fftSize = fftSize;

        const floatTime = new Float32Array(analyser.fftSize),
              floatFreq = new Float32Array(analyser.frequencyBinCount),
              intTime = new Uint8Array(analyser.fftSize),
              intFreq = new Uint8Array(analyser.frequencyBinCount);

        three.on('update', () => {
          analyser.getFloatTimeDomainData(floatTime);
          analyser.getFloatFrequencyData(floatFreq);

          analyser.getByteTimeDomainData(intTime);
          analyser.getByteFrequencyData(intFreq);
        });

        mathbox.select('#audioTime').set('data', floatTime);
        mathbox.select('#audioFreq').set('data', floatFreq);

        mathbox.select('#intTime').set('data', intTime);
        mathbox.select('#intFreq').set('data', intFreq);
      }

    </script>
  </body>
</html>